<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metro Terminal ‚Äî K√≥dy</title>
  <style>
    :root{
      --bg:#050505;
      --panel:#0e0e0e;
      --accent:#8b0000;
      --green:#00ff66;
      --text:#d8d8d8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%;margin:0;padding:0}
    body{
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color:var(--text);
      font-family: var(--mono);
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    #app{
      width:100%;
      max-width:900px;
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 12px;
      background: linear-gradient(90deg, rgba(20,20,20,0.9), rgba(10,10,10,0.85));
      border-bottom:2px solid rgba(139,0,0,0.6);
    }
    #center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px}
    .big-title{font-size:42px;letter-spacing:3px;color:#bfbfbf}
    #console{
      width:92%;
      max-width:760px;
      background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(10,10,10,0.45));
      border:1px solid rgba(80,80,80,0.3);
      padding:10px;
      margin-top:12px;
      box-shadow: inset 0 0 24px rgba(0,0,0,0.6);
      border-left:6px solid var(--accent);
      font-size:14px;
      max-height:200px;
      overflow-y:auto;
      color: var(--green);
      display:flex;
      flex-direction:column;
    }
    .console-title{font-size:12px;color:#bdbdbd;margin-bottom:6px}
    #status-msg{
      margin-bottom:8px;
      color:#ccc;
      min-height:20px;
      font-size:14px;
    }
    #history{list-style:none;margin:0;padding:0;}
    #history li{padding:6px 8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
    .resources{
      display:flex;
      justify-content:center;
      gap:20px;
      padding:8px;
      background:linear-gradient(180deg,#070707,#0b0b0b);
      border-top:2px solid rgba(139,0,0,0.6);
      border-bottom:2px solid rgba(139,0,0,0.6);
      font-size:14px;
    }
    .resources span{color:var(--green);}
    #code-form{
      display:flex;
      gap:8px;
      padding:10px;
      background:linear-gradient(180deg,#070707,#0b0b0b);
      border-top:3px solid rgba(139,0,0,0.6);
    }
    #code-input{
      flex:1;
      padding:12px 14px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--green);
      font-size:16px;
      outline:none;
    }
    #code-submit{
      padding:10px 16px;
      background:linear-gradient(180deg,#220000,var(--accent));
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:700;
    }
  </style>
</head>
<body>
  <main id="app">
    <header class="topbar">
      <span>TERMIN√ÅL ‚Ä¢ STANICE</span>
      <span style="color:red;">OFFLINE</span>
    </header>

    <section id="center">
      <div class="big-title">METRO 2033</div>
      <div id="console">
        <div id="status-msg"></div>
        <ul id="history"></ul>
      </div>
    </section>

    <div class="resources">
      <div>Baterie: <span id="res-b">0</span></div>
      <div>Filtry: <span id="res-f">0</span></div>
      <div>Voda: <span id="res-w">0</span></div>
    </div>

    <form id="code-form" autocomplete="off">
      <input id="code-input" type="text" maxlength="40" placeholder="Zadej k√≥d..." />
      <button id="code-submit" type="submit">OK</button>
    </form>
  </main>

  <script>
    const STORAGE_HISTORY_KEY = 'metro_codes_history_v1';
    const STORAGE_USED_CODES_KEY = 'metro_used_codes_v1';

    let codesDB = {};
    let batteryCount = 0;
    let filterCount = 0;
    let waterCount = 0;

    const hist = document.getElementById('history');
    const statusMsg = document.getElementById('status-msg');
    const resB = document.getElementById('res-b');
    const resF = document.getElementById('res-f');
    const resW = document.getElementById('res-w');

    function loadHistory(){
      try { return JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY)) || []; }
      catch { return []; }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(arr));
    }
    function loadUsedCodes(){
      try { return JSON.parse(localStorage.getItem(STORAGE_USED_CODES_KEY)) || []; }
      catch { return []; }
    }
    function saveUsedCodes(arr){
      localStorage.setItem(STORAGE_USED_CODES_KEY, JSON.stringify(arr));
    }
    function renderHistory(){
      const list = loadHistory();
      hist.innerHTML = '';
      if(list.length === 0){
        const li = document.createElement('li');
        li.textContent = '(≈Ω√°dn√© k√≥dy)';
        li.style.color = '#9a9a9a';
        hist.appendChild(li);
        return;
      }
      list.slice().reverse().forEach(item=>{
        const li = document.createElement('li');
        const time = new Date(item.t).toLocaleTimeString();
        li.textContent = `${item.code} ‚Äî ${time}`;
        hist.appendChild(li);
      });
    }
    function updateResourcesPanel(){
      resB.textContent = batteryCount;
      resF.textContent = filterCount;
      resW.textContent = waterCount;
    }
    async function loadCodesDB(){
      try {
        const resp = await fetch('codes-db.json', {cache:"reload"});
        if(!resp.ok) throw new Error();
        codesDB = await resp.json();
        statusMsg.textContent = 'Datab√°ze k√≥d≈Ø naƒçtena.';
      } catch(e){
        statusMsg.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ datab√°ze.';
      }
    }

    document.getElementById('code-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const input = document.getElementById('code-input');
      const code = input.value.trim().toUpperCase();
      if(!code){
        statusMsg.textContent = 'Zadej k√≥d!';
        return;
      }

      // üîπ Speci√°ln√≠ resetovac√≠ k√≥d
      if(code === 'RESET'){
        const ok = confirm('Opravdu chce≈° vymazat ve≈°ker√° lok√°ln√≠ data? (Historie, pou≈æit√© k√≥dy, z√°soby)');
        if(ok){
          localStorage.removeItem(STORAGE_HISTORY_KEY);
          localStorage.removeItem(STORAGE_USED_CODES_KEY);
          batteryCount = 0;
          filterCount = 0;
          waterCount = 0;
          updateResourcesPanel();
          renderHistory();
          statusMsg.textContent = 'Lok√°ln√≠ data byla vymaz√°na.';
        } else {
          statusMsg.textContent = 'Reset zru≈°en.';
        }
        input.value = '';
        return;
      }

      if(!codesDB[code]){
        statusMsg.textContent = 'Neplatn√Ω k√≥d.';
        input.value = '';
        return;
      }

      const value = codesDB[code];
      const firstLetter = code.charAt(0);
      const secondLetter = code.charAt(1);
      const usedCodes = loadUsedCodes();
      if(firstLetter === 'U' && usedCodes.includes(code)){
        statusMsg.textContent = 'Tento k√≥d ji≈æ byl pou≈æit.';
        input.value = '';
        return;
      }

      switch(secondLetter){
        case 'B':
          batteryCount += value;
          statusMsg.textContent = `P≈ôid√°ny baterie: ${value}`;
          break;
        case 'F':
          filterCount += value;
          statusMsg.textContent = `P≈ôid√°ny filtry: ${value}`;
          break;
        case 'W':
          waterCount += value;
          statusMsg.textContent = `P≈ôid√°na voda: ${value}`;
          break;
        default:
          statusMsg.textContent = 'Nezn√°m√Ω typ k√≥du.';
          return;
      }

      updateResourcesPanel();
      let history = loadHistory();
      history.push({code, t: Date.now()});
      saveHistory(history);
      if(firstLetter === 'U'){
        usedCodes.push(code);
        saveUsedCodes(usedCodes);
      }
      renderHistory();
      input.value = '';
      input.focus();
    });

    (async()=>{
      await loadCodesDB();
      renderHistory();
      updateResourcesPanel();
    })();
  </script>
</body>
</html>
