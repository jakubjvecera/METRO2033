<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metro Terminal — Kódy</title>
  <style>
    /* ... (ponech tvůj styl z předchozí verze, hlavně .topbar, #console, #code-form atd.) ... */
    :root{
      --bg:#050505;
      --panel:#0e0e0e;
      --accent:#8b0000;
      --green:#00ff66;
      --text:#d8d8d8;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%;margin:0;padding:0}
    body{
      background: linear-gradient(180deg, #050505 0%, #0b0b0b 100%);
      color:var(--text);
      font-family: var(--mono);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    #app{
      width:100%;
      max-width:900px;
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 12px;
      background: linear-gradient(90deg, rgba(20,20,20,0.9), rgba(10,10,10,0.85));
      border-bottom:2px solid rgba(139,0,0,0.6);
      box-shadow:0 2px 8px rgba(0,0,0,0.6);
    }
    .top-buttons{
      display:flex;
      gap:8px;
    }
    .top-btn{
      width:40px;
      height:40px;
      background:linear-gradient(180deg,#1a1a1a,#0d0d0d);
      border:1px solid rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.15s ease;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.4);
    }
    .top-btn:hover{
      background:linear-gradient(180deg,#262626,#121212);
      border-color:rgba(255,255,255,0.12);
    }
    .top-btn:active{
      transform:translateY(1px);
    }
    .top-btn img{
      width:24px;
      height:24px;
      object-fit:contain;
      filter:invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(90%);
    }
    #center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px}
    .big-title{font-size:42px;letter-spacing:3px;color:#bfbfbf}
    #console{
      width:92%;
      max-width:760px;
      background:linear-gradient(180deg, rgba(0,0,0,0.55), rgba(10,10,10,0.45));
      border:1px solid rgba(80,80,80,0.3);
      padding:10px;
      margin-top:12px;
      box-shadow: inset 0 0 24px rgba(0,0,0,0.6);
      border-left:6px solid var(--accent);
      font-size:14px;
      max-height:180px;
      overflow-y:auto;
      color: var(--green);
    }
    .console-title{font-size:12px;color:#bdbdbd;margin-bottom:6px}
    #history{list-style:none;margin:0;padding:0;}
    #history li{padding:6px 8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
    #code-form{
      display:flex;
      gap:8px;
      padding:10px;
      background:linear-gradient(180deg,#070707,#0b0b0b);
      border-top:3px solid rgba(139,0,0,0.6);
    }
    #code-input{
      flex:1;
      padding:12px 14px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--green);
      font-size:16px;
      outline:none;
      box-shadow: inset 0 -14px 30px rgba(0,0,0,0.5);
      caret-color: #fff;
    }
    #code-input::placeholder{color:rgba(0,255,102,0.18)}
    #code-submit{
      padding:10px 16px;
      background:linear-gradient(180deg,#220000,var(--accent));
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:700;
      letter-spacing:1px;
    }
    #code-submit:active{transform:translateY(1px)}
    @media (max-width:420px){
      .big-title{font-size:28px}
      #console{width:96%}
      .top-buttons{gap:4px}
      .top-btn{width:36px;height:36px}
      .top-btn img{width:20px;height:20px}
    }
  </style>
</head>
<body>
  <main id="app">
    <header class="topbar">
      <div class="brand">
        <div class="lamp"></div>
        <span>TERMINÁL • STANICE</span>
      </div>

      <div class="top-buttons">
        <button class="top-btn" title="Svítilna">
          <img src="placeholder-svitilna.svg" alt="Svítilna" />
        </button>
        <button class="top-btn" title="Mapa">
          <img src="placeholder-mapa.svg" alt="Mapa" />
        </button>
      </div>

      <div class="status">
        <span class="dot red"></span><span>OFFLINE</span>
      </div>
    </header>

    <section id="center">
      <div class="big-title">METRO 2033</div>

      <div id="console">
        <div class="console-title">Historie kódů a stav</div>
        <ul id="history"></ul>
        <div id="status-msg" style="margin-top:8px;color:#ccc;min-height:20px;"></div>
      </div>
    </section>

    <form id="code-form" autocomplete="off">
      <input id="code-input" name="code" type="text" maxlength="40" placeholder="Zadej kód..." aria-label="Zadej kód" />
      <button id="code-submit" type="submit">OK</button>
    </form>
  </main>

  <script>
    const STORAGE_HISTORY_KEY = 'metro_codes_history_v1';
    const STORAGE_USED_U_CODES = 'metro_used_u_codes_v1';
    let codesDB = [];
    let batteryCount = 0;

    const form = document.getElementById('code-form');
    const input = document.getElementById('code-input');
    const hist = document.getElementById('history');
    const statusMsg = document.getElementById('status-msg');

    // načtení historie z localStorage
    function loadHistory(){
      try {
        const raw = localStorage.getItem(STORAGE_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(arr));
    }

    // U-kódy, které už byly použity (jednorázové)
    function loadUsedUCodes(){
      try {
        const raw = localStorage.getItem(STORAGE_USED_U_CODES);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }
    function saveUsedUCodes(arr){
      localStorage.setItem(STORAGE_USED_U_CODES, JSON.stringify(arr));
    }

    // vykreslení historie
    function renderHistory(){
      const list = loadHistory();
      hist.innerHTML = '';
      if(list.length === 0){
        const li = document.createElement('li');
        li.textContent = '(Žádné kódy)';
        li.style.color = '#9a9a9a';
        hist.appendChild(li);
        return;
      }
      list.slice().reverse().forEach(item=>{
        const li = document.createElement('li');
        const time = new Date(item.t).toLocaleTimeString();
        li.textContent = `${item.code} — ${time}`;
        hist.appendChild(li);
      });
    }

    // zobrazení statusu (stav baterií atd.)
    function updateStatus(){
      statusMsg.textContent = `Baterie: ${batteryCount}`;
    }

    // akce podle kódu
    function performAction(codeObj){
      // Pokud je kód U* (user), přidáme baterie (pokud je value)
      if(codeObj.code.startsWith('U')){
        if(codeObj.value){
          batteryCount += codeObj.value;
          updateStatus();
          return `Přidáno ${codeObj.value} baterií.`;
        }
        return 'Kód neobsahuje hodnotu.';
      }
      // Kódy S* - servisní, např. SOPEN, SPOWER
      else if(codeObj.code.startsWith('S')){
        switch(codeObj.code){
          case 'SOPEN': return 'Dveře otevřeny.';
          case 'SPOWER': return 'Napájení zapnuto.';
          default: return `Servisní kód: ${codeObj.code}`;
        }
      }
      return 'Neznámý kód.';
    }

    // Načtení databáze z JSONu
    async function loadCodesDB(){
      try {
        const resp = await fetch('codes-db.json', {cache: "reload"});
        if(!resp.ok) throw new Error('Nepodařilo se načíst databázi kódů.');
        codesDB = await resp.json();
        statusMsg.textContent = 'Databáze kódů načtena.';
      } catch(e){
        statusMsg.textContent = 'Chyba při načítání databáze kódů.';
        console.error(e);
      }
    }

    // Kontrola a zpracování kódu po submitu
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = input.value.trim().toUpperCase();
      if(!code){
        statusMsg.textContent = 'Zadej kód!';
        return;
      }
      if(codesDB.length === 0){
        statusMsg.textContent = 'Databáze kódů se ještě nenačetla, počkej.';
        return;
      }

      const codeObj = codesDB.find(c => c.code === code);
      if(!codeObj){
        statusMsg.textContent = 'Neplatný kód.';
        input.value = '';
        return;
      }

      if(code.startsWith('U')){
        // jednorázové kódy - zkontrolujeme, zda již nebyl použit
        let used = loadUsedUCodes();
        if(used.includes(code)){
          statusMsg.textContent = 'Tento kód již byl použit.';
          input.value = '';
          return;
        }
        // kód přijímáme, uložíme do historie i do použité
        used.push(code);
        saveUsedUCodes(used);
      }
      // kódy S* jsou neomezené, nemusíme nic extra dělat

      // uložíme do historie
      let history = loadHistory();
      history.push({code, t: Date.now()});
      saveHistory(history);
      renderHistory();

      // vykonáme akci
      const actionMsg = performAction(codeObj);
      statusMsg.textContent = actionMsg;

      input.value = '';
      input.focus();
    });

    // inicializace
    (async () => {
      await loadCodesDB();
      renderHistory();
      updateStatus();
      input.focus();
    })();
  </script>
</body>
</html>
